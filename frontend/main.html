<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartNote - Gestionnaire de Notes</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/script.js" defer></script>
</head>
<body>

<header>
    <div class="logo"><strong>SmartNote</strong></div>
    <div class="user-info">
        <span>Utilisateur : <strong>{{ email }}</strong></span>
        <a href="/logout" class="logout-btn">Déconnexion</a>
    </div>
</header>

<div class="container">
    <section class="selection-box">
        <form method="POST" class="flex-form">
            <div class="form-group">
                <label>Année académique</label>
                <select name="annee">
                    {% for annee in annees %}
                        <option value="{{ annee }}" {% if annee == annee_sel %}selected{% endif %}>{{ annee }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Semestre</label>
                <select name="semestre">
                    <option value="Semestre 1" {% if sem_sel == "Semestre 1" %}selected{% endif %}>Semestre 1</option>
                    <option value="Semestre 2" {% if sem_sel == "Semestre 2" %}selected{% endif %}>Semestre 2</option>
                </select>
            </div>
            <button type="submit" class="btn-load">Charger</button>
        </form>
    </section>

    {% if poles %}
        <form action="/enregistrer" method="POST">
            <input type="hidden" name="annee_origine" value="{{ annee_sel }}">
            <input type="hidden" name="semestre_origine" value="{{ sem_sel }}">

            {% for p in poles %}
                <article class="pole-card">
                    <div class="pole-header">
                        <h3>Pôle : {{ p.nom or p.pole }}</h3>
                        <div class="average-badge">
                            Moyenne : {{ moyennes.get(p.nom, moyennes.get(p.pole, "N/A")) }}
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Matière</th>
                                    <th>Notes & Saisie</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in p.matieres %}
                                <tr>
                                    <td class="code-cell">{{ m.code }}</td>
                                    <td>{{ m.nom }}</td>
                                    <td>
                                        <div class="existing-notes">
                                            {% set notes_m = notes_enregistrees.get(m.code, []) %}
                                            {% for n in notes_m %}
                                                <span class="note-tag">
                                                    {{ n.note }} <small>(c{{ n.coef }})</small>
                                                    <span class="btn-suppr" onclick="supprimerNoteReel('{{ m.code }}', '{{ loop.index0 }}')">×</span>
                                                </span>
                                            {% else %}
                                                <span class="no-notes">Aucune note</span>
                                            {% endfor %}
                                        </div>

                                        <div id="container-{{ m.code }}" class="dynamic-inputs"></div>
                                        <button type="button" class="add-note-btn" onclick="ajouterChamp('{{ m.code }}')">+ Note</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </article>
            {% endfor %}

            <footer class="save-bar">
                <button type="submit" class="btn-save">Sauvegarder et recalculer</button>
            </footer>
        </form>
    {% else %}
        <div class="empty-state">
            <p>Veuillez sélectionner une année et un semestre pour afficher les matières.</p>
        </div>
    {% endif %}
</div>
</body>
</html>